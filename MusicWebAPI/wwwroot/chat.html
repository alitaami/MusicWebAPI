<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SignalR Group Chat</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e8ebf0;
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        .chat-section {
            flex: 3;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background-color: #ffffff;
            border-right: 1px solid #ccc;
        }

        .header {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

            .header input {
                padding: 8px;
                flex: 1;
            }

            .header button {
                padding: 8px 12px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #f7f7f7;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        #messagesList {
            list-style: none;
            padding: 0;
            margin: 0;
        }

            #messagesList li {
                margin-bottom: 10px;
                line-height: 1.4;
            }

        .system-message {
            color: gray;
            font-style: italic;
        }

        .message-input {
            display: flex;
            gap: 10px;
        }

            .message-input input {
                flex: 1;
                padding: 10px;
                border-radius: 4px;
                border: 1px solid #ccc;
            }

            .message-input button {
                padding: 10px 16px;
                background-color: #28a745;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

        .sidebar {
            flex: 1;
            background-color: #f1f5f9;
            padding: 20px;
            overflow-y: auto;
        }

            .sidebar h3 {
                margin-top: 0;
                font-size: 18px;
                margin-bottom: 10px;
            }

        .member-item {
            padding: 6px 10px;
            background-color: #fff;
            margin-bottom: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
</head>
<body>
    <div class="main-container">
        <!-- Chat Section -->
        <div class="chat-section">
            <div class="header">
                <input type="text" id="username" placeholder="Username" />
                <select id="groupName">
                    <option value="">Select Group</option>
                </select>
                <button id="joinGroup">Join</button>
                <button id="leaveGroup">Leave</button>
            </div>

            <div class="chat-box">
                <ul id="messagesList"></ul>
            </div>

            <div class="message-input">
                <input type="text" id="messageInput" placeholder="Type your message..." />
                <button id="sendButton">Send</button>
            </div>
        </div>

        <!-- Members Section -->
        <div class="sidebar">
            <h3>Group Members</h3>
            <div id="membersList">
                <!-- Dynamic user list -->
            </div>
        </div>
    </div>

    <script>
        "use strict";

        let connection = null;
        let groupName = '';
        let username = '';
        let isJoined = false;
        const deferredSystemMessages = [];
        let chatHistoryLoaded = false;

        const joinBtn = document.getElementById("joinGroup");
        const leaveBtn = document.getElementById("leaveGroup");
        const sendBtn = document.getElementById("sendButton");
        const messagesList = document.getElementById("messagesList");
        const membersList = document.getElementById("membersList");
        const messageInput = document.getElementById("messageInput");

        function renderMembers(members) {
            membersList.innerHTML = '';
            members.forEach(m => {
                const div = document.createElement("div");
                div.className = "member-item";
                div.textContent = m.username || m.fullName || m.userId;
                membersList.appendChild(div);
            });
        }

        let handlersRegistered = false;

        async function initializeConnection() {
            if (connection && connection.state === signalR.HubConnectionState.Connected)
                return;

            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chathub")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            if (!handlersRegistered) {
                registerEventHandlers();
                handlersRegistered = true;
            }

            try {
                await connection.start();
                console.log("Connected to SignalR Hub");
            } catch (err) {
                console.error("Connection failed: ", err.toString());
            }
        }


        function registerEventHandlers() {

            connection.off("ReceiveMessage");
            connection.off("UserJoined");
            connection.off("UserLeft");
            connection.off("GroupMembers");
            connection.off("ChatHistory");

            connection.on("ReceiveMessage", (message) => {
                const li = document.createElement("li");
                li.textContent = `${message.senderUsername || message.senderId}: ${message.content}`;
                messagesList.appendChild(li);
                messagesList.scrollTop = messagesList.scrollHeight;
            });

            connection.on("UserJoined", async (userId) => {
                try {
                    const username = await connection.invoke("GetUsernameByUserId", userId);
                    const li = document.createElement("li");
                    li.textContent = `${username ?? userId} joined the group.`;
                    li.className = "system-message";

                    if (!chatHistoryLoaded) {
                        deferredSystemMessages.push(li);
                    } else {
                        messagesList.appendChild(li);
                    }

                    await connection.invoke("GetGroupMembers", groupName);
                } catch (error) {
                    console.error("Error fetching username:", error);
                }
            });

            connection.on("UserLeft", async (userId) => {
                try {
                    const username = await connection.invoke("GetUsernameByUserId", userId);
                    const li = document.createElement("li");
                    li.textContent = `${username ?? userId} left the group.`;
                    li.className = "system-message";

                    if (!chatHistoryLoaded) {
                        deferredSystemMessages.push(li);
                    } else {
                        messagesList.appendChild(li);
                    }

                    await connection.invoke("GetGroupMembers", groupName);
                } catch (error) {
                    console.error("Error fetching username:", error);
                }
            });

            connection.on("GroupMembers", (members) => {
                renderMembers(members);
            });

            connection.on("ChatHistory", (messages) => {
                messages.reverse().forEach(msg => {
                    const li = document.createElement("li");
                    li.textContent = `${msg.senderUsername || msg.senderId}: ${msg.content}`;
                    messagesList.appendChild(li);
                });

                chatHistoryLoaded = true;

                // 🔥 Append any deferred system messages
                deferredSystemMessages.forEach(msg => {
                    messagesList.appendChild(msg);
                });
                deferredSystemMessages.length = 0;
            });

        }

        joinBtn.addEventListener("click", async () => {
            chatHistoryLoaded = false; // Reset before fetching

            username = document.getElementById("username").value.trim();
            groupName = document.getElementById("groupName").value;

            if (isJoined) {
                alert("You have already joined this group.");
                return;
            }

            if (!username || !groupName) {
                alert("Please enter a username and select a group.");
                return;
            }

            await initializeConnection();

            try {
                await connection.invoke("JoinGroup", groupName, username);
                await connection.invoke("GetGroupMembers", groupName);
                await connection.invoke("GetChats", groupName, 0, 50);
                isJoined = true;
            } catch (err) {
                console.error("Join failed:", err.toString());
            }
        });

        leaveBtn.addEventListener("click", async () => {
            if (!isJoined || !connection || connection.state !== signalR.HubConnectionState.Connected) return;

            try {
                await connection.invoke("LeaveGroup", groupName, username);
                 
                messagesList.innerHTML = "";
                membersList.innerHTML = "";
                isJoined = false;
                groupName = '';
                chatHistoryLoaded = false; // Reset before fetching

            } catch (err) {
                console.error("Leave failed:", err.toString());
            }
        });


        sendBtn.addEventListener("click", async () => {
            const message = messageInput.value.trim();

            if (!message) return;

            if (!isJoined || !connection || connection.state !== signalR.HubConnectionState.Connected) {
                alert("Please join a group first.");
                return;
            }

            try {
                await connection.invoke("SendMessage", groupName, username, message, null);
                messageInput.value = '';
            } catch (err) {
                console.error("Failed to send message:", err.toString());
            }
        });

        // Optional: auto-load groups on page load
        window.addEventListener("DOMContentLoaded", async () => {
            try {
                await initializeConnection();
                const groups = await connection.invoke("GetGroups");
                const groupSelect = document.getElementById("groupName");
                groupSelect.innerHTML = '<option value="">Select Group</option>';
                groups.forEach(group => {
                    const option = document.createElement("option");
                    option.value = group.name;
                    option.textContent = group.name;
                    groupSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading groups:", error);
            }
        });
    </script>

</body>
</html>
